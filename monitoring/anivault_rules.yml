# Prometheus alerting rules for AniVault
# Place this file in your Prometheus rules directory and reference it in prometheus.yml

groups:
  - name: anivault_sync_alerts
    rules:
      - alert: HighSyncFailureRate
        expr: rate(anivault_sync_operations_total{status="failed"}[5m]) / rate(anivault_sync_operations_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: sync
        annotations:
          summary: "High sync operation failure rate detected"
          description: "Sync operation failure rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook_url: "https://docs.anivault.com/monitoring#high-sync-failure-rate"

      - alert: SyncFailureRateCritical
        expr: rate(anivault_sync_operations_total{status="failed"}[5m]) / rate(anivault_sync_operations_total[5m]) > 0.3
        for: 1m
        labels:
          severity: critical
          component: sync
        annotations:
          summary: "Critical sync operation failure rate"
          description: "Sync operation failure rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook_url: "https://docs.anivault.com/monitoring#critical-sync-failure-rate"

      - alert: LowCacheHitRate
        expr: rate(anivault_cache_events_total{event_type="hit"}[5m]) / (rate(anivault_cache_events_total{event_type="hit"}[5m]) + rate(anivault_cache_events_total{event_type="miss"}[5m])) < 0.5
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Low cache hit rate detected"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook_url: "https://docs.anivault.com/monitoring#low-cache-hit-rate"

      - alert: CacheHitRateCritical
        expr: rate(anivault_cache_events_total{event_type="hit"}[5m]) / (rate(anivault_cache_events_total{event_type="hit"}[5m]) + rate(anivault_cache_events_total{event_type="miss"}[5m])) < 0.2
        for: 2m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "Critical cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for the last 5 minutes"
          runbook_url: "https://docs.anivault.com/monitoring#critical-cache-hit-rate"

      - alert: HighSyncLatency
        expr: histogram_quantile(0.95, rate(anivault_sync_operation_duration_seconds_bucket[5m])) > 5
        for: 3m
        labels:
          severity: warning
          component: sync
        annotations:
          summary: "High sync operation latency detected"
          description: "95th percentile sync operation latency is {{ $value }}s"
          runbook_url: "https://docs.anivault.com/monitoring#high-sync-latency"

      - alert: SyncLatencyCritical
        expr: histogram_quantile(0.95, rate(anivault_sync_operation_duration_seconds_bucket[5m])) > 10
        for: 1m
        labels:
          severity: critical
          component: sync
        annotations:
          summary: "Critical sync operation latency"
          description: "95th percentile sync operation latency is {{ $value }}s"
          runbook_url: "https://docs.anivault.com/monitoring#critical-sync-latency"

  - name: anivault_health_alerts
    rules:
      - alert: DatabaseUnhealthy
        expr: anivault_database_health_status == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database health check failed"
          description: "Database health status is unhealthy"
          runbook_url: "https://docs.anivault.com/monitoring#database-unhealthy"

      - alert: CircuitBreakerOpen
        expr: anivault_circuit_breaker_state == 1
        for: 30s
        labels:
          severity: warning
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker is open"
          description: "Circuit breaker {{ $labels.breaker_name }} is in open state"
          runbook_url: "https://docs.anivault.com/monitoring#circuit-breaker-open"

      - alert: CircuitBreakerOpenCritical
        expr: anivault_circuit_breaker_state == 1
        for: 5m
        labels:
          severity: critical
          component: circuit_breaker
        annotations:
          summary: "Circuit breaker open for extended period"
          description: "Circuit breaker {{ $labels.breaker_name }} has been open for more than 5 minutes"
          runbook_url: "https://docs.anivault.com/monitoring#circuit-breaker-open-critical"

      - alert: HighDatabaseErrorRate
        expr: rate(anivault_database_connection_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High database error rate"
          description: "Database error rate is {{ $value }} errors per second"
          runbook_url: "https://docs.anivault.com/monitoring#high-database-error-rate"

  - name: anivault_consistency_alerts
    rules:
      - alert: DataInconsistenciesDetected
        expr: increase(anivault_consistency_inconsistencies_total[1h]) > 0
        for: 0m
        labels:
          severity: warning
          component: consistency
        annotations:
          summary: "Data inconsistencies detected"
          description: "{{ $value }} data inconsistencies detected in the last hour"
          runbook_url: "https://docs.anivault.com/monitoring#data-inconsistencies"

      - alert: HighInconsistencyRate
        expr: rate(anivault_consistency_inconsistencies_total[5m]) > 0.01
        for: 2m
        labels:
          severity: critical
          component: consistency
        annotations:
          summary: "High data inconsistency rate"
          description: "Data inconsistency rate is {{ $value }} per second"
          runbook_url: "https://docs.anivault.com/monitoring#high-inconsistency-rate"

      - alert: ReconciliationFailures
        expr: rate(anivault_reconciliation_operations_total{status="failed"}[5m]) > 0
        for: 1m
        labels:
          severity: warning
          component: reconciliation
        annotations:
          summary: "Reconciliation failures detected"
          description: "Reconciliation failure rate is {{ $value }} per second"
          runbook_url: "https://docs.anivault.com/monitoring#reconciliation-failures"

  - name: anivault_resource_alerts
    rules:
      - alert: HighCacheMemoryUsage
        expr: anivault_cache_memory_usage_bytes > 100 * 1024 * 1024  # 100MB
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "High cache memory usage"
          description: "Cache memory usage is {{ $value | humanizeBytes }}"
          runbook_url: "https://docs.anivault.com/monitoring#high-cache-memory"

      - alert: CacheMemoryUsageCritical
        expr: anivault_cache_memory_usage_bytes > 500 * 1024 * 1024  # 500MB
        for: 2m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "Critical cache memory usage"
          description: "Cache memory usage is {{ $value | humanizeBytes }}"
          runbook_url: "https://docs.anivault.com/monitoring#critical-cache-memory"

      - alert: MetricsServerDown
        expr: up{job="anivault"} == 0
        for: 1m
        labels:
          severity: critical
          component: monitoring
        annotations:
          summary: "AniVault metrics server is down"
          description: "AniVault metrics server has been down for more than 1 minute"
          runbook_url: "https://docs.anivault.com/monitoring#metrics-server-down"
