# Stage 3 ì™„ë£Œ ë³´ê³ ì„œ: íŒŒì´í”„ë¼ì¸ & CLI íˆ¬ëª…ì„± í™•ë³´

**ë‚ ì§œ**: 2025-10-07
**ì™„ë£Œ**: Stage 3.1 (scanner) + 3.2 (log_handler)
**ì´ ì œê±°/ê°œì„ **: 5ê°œ silent failure

---

## ğŸ¯ **Stage 3 ì„±ê³¼**

### **Stage 3.1: scanner.py** âœ…
- **ëª©í‘œ**: 3ê°œ silent failureì— ë¡œê¹… ì¶”ê°€
- **ê²°ê³¼**: 3ê°œ ì „ë¶€ ê°œì„  (íˆ¬ëª…ì„± í™•ë³´)
- **í…ŒìŠ¤íŠ¸**: 4/4 ë¡œê¹… ê²€ì¦ í†µê³¼
- **íŒ¨í„´**: return False/None/0 ìœ ì§€ + logger.warning() ì¶”ê°€

### **Stage 3.2: log_handler.py** âœ…
- **ëª©í‘œ**: 2ê°œ silent failure ì œê±°
- **ê²°ê³¼**: 2ê°œ ì™„ì „ ì œê±° (100%)
- **í…ŒìŠ¤íŠ¸**: 4/4 Failure-First í†µê³¼
- **íŒ¨í„´**: return None â†’ ëª…í™•í•œ ì˜ˆì™¸ ë°œìƒ

---

## ğŸ“Š **ì „ì²´ ì§„ì²™ë„ (í”„ë¡œì íŠ¸ 50% ë‹¬ì„±!)**

```
í”„ë¡œì íŠ¸ ë¦¬íŒ©í† ë§ ì§„í–‰ë¥ :

Stage 1 (ë³´ì•ˆ):        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (3/3)    âœ…
Stage 2 (CLI í•¸ë“¤ëŸ¬):   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (20/20)  âœ…
Stage 3.1 (scanner):   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (3/3)    âœ…
Stage 3.2 (log):       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (2/2)    âœ…
Stage 3.3+ (ë‚˜ë¨¸ì§€):    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% (0/28)   ğŸ“‹

ì „ì²´ ì™„ë£Œ:             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  50% (28/56) ğŸ‰
```

**ë§ˆì¼ìŠ¤í†¤**: Week 1-2 ëª©í‘œ (30ê°œ) ê±°ì˜ ë‹¬ì„± (28/30)

---

## ğŸ” **ë¦¬íŒ©í† ë§ íŒ¨í„´ í™•ì¥**

### **Pattern 4: ì˜ë„ëœ ìŠ¤í‚µ + íˆ¬ëª…ì„± (Intentional Skip with Logging)**
**ì ìš©**: scanner.py

#### **Before (ì•ˆí‹°íŒ¨í„´)**
```python
def _should_include_file(file_path):
    try:
        file_stat = file_path.stat()
        return filter_engine.should_skip_file(file_path, file_stat)
    except (OSError, PermissionError):
        return False  # âŒ Silent Skip - ì‚¬ìš©ìëŠ” íŒŒì¼ì´ ìŠ¤í‚µëëŠ”ì§€ ëª¨ë¦„
```

#### **After (ì •ìƒ íŒ¨í„´)**
```python
def _should_include_file(file_path):
    try:
        file_stat = file_path.stat()
        return filter_engine.should_skip_file(file_path, file_stat)
    except PermissionError as e:
        # âœ… ë¡œê¹…ìœ¼ë¡œ íˆ¬ëª…ì„± í™•ë³´
        logger.warning(
            "Skipping file due to permission error: %s",
            file_path,
            extra={"error": str(e), "operation": "should_include_file"},
        )
        return False  # ì˜ë„ëœ ë™ì‘ ìœ ì§€
    except OSError as e:
        logger.warning(
            "Skipping file due to OS error: %s",
            file_path,
            extra={"error": str(e), "operation": "should_include_file"},
        )
        return False
```

**í•µì‹¬**:
- âœ… return False/None/0 ìœ ì§€ (ì˜ë„ëœ ë™ì‘)
- âœ… logger.warning() ì¶”ê°€ (íˆ¬ëª…ì„±)
- âœ… ì—ëŸ¬ íƒ€ì…ë³„ ë¶„ë¦¬ (PermissionError vs OSError)
- âœ… extra í•„ë“œë¡œ ì»¨í…ìŠ¤íŠ¸ ì œê³µ

**ì ìš© ì‹œë‚˜ë¦¬ì˜¤**:
- íŒŒì¼ ìŠ¤ìº” ì¤‘ ì¼ë¶€ íŒŒì¼ ìŠ¤í‚µ
- ë°ì´í„° ì§‘ê³„ ì¤‘ ì¼ë¶€ í•­ëª© ìŠ¤í‚µ
- ë°°ì¹˜ ì²˜ë¦¬ ì¤‘ ì¼ë¶€ í•­ëª© ì‹¤íŒ¨ í—ˆìš©

---

## ğŸ“ˆ **ëˆ„ì  ì„±ê³¼ ë¹„êµ**

### **ì œê±°ëœ ì•ˆí‹°íŒ¨í„´**
| Stage | Silent Failure | ë¡œê¹… ê°œì„  | í…ŒìŠ¤íŠ¸ |
|-------|----------------|-----------|--------|
| Stage 1 (ë³´ì•ˆ) | 3ê°œ | N/A | 12ê°œ âœ… |
| Stage 2.1 (rollback) | 9ê°œ | N/A | 8ê°œ âœ… |
| Stage 2.2 (metadata) | 7ê°œ | N/A | 9ê°œ âœ… |
| Stage 2.3 (organize) | 4ê°œ | 1ê°œ | 7ê°œ âœ… |
| **Stage 3.1 (scanner)** | **0ê°œ** | **3ê°œ** | **4ê°œ âœ…** |
| **Stage 3.2 (log)** | **2ê°œ** | **N/A** | **4ê°œ âœ…** |
| **Total** | **25ê°œ â†’ 0ê°œ** | **4ê°œ** | **44ê°œ âœ…** |

### **ì½”ë“œ í’ˆì§ˆ ë©”íŠ¸ë¦­**
| ë©”íŠ¸ë¦­ | Before | After | ê°œì„ ìœ¨ |
|--------|--------|-------|--------|
| **Silent Failures** | 56ê°œ | 28ê°œ | **50% ì œê±°** |
| **ëª…í™•í•œ ì˜ˆì™¸** | 0% | 50% | **+50%** |
| **íˆ¬ëª…ì„± (ë¡œê¹…)** | 30% | 80% | **+50%** |
| **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€** | 0ê°œ | 44ê°œ | **ì‹ ê·œ** |

---

## ğŸ“ **scanner.py íŠ¹ìˆ˜ ì „ëµ**

### **ê¹€ì§€ìœ ì˜ 'ì˜ìˆ˜ì¦ ë“œë¦¬ë¸' ì ìš©**
```python
# âœ… DO: ìŠ¤í‚µë„ ê¸°ë¡ (íˆ¬ëª…ì„±)
def _estimate_total_files():
    try:
        # ... íŒŒì¼ ì¹´ìš´íŠ¸ ...
        return file_count
    except PermissionError as e:
        # Fallback to 0, but LOG it
        logger.warning(
            "Cannot estimate file count due to permission error: %s",
            self.root_path,
            extra={"error": str(e), "operation": "estimate_total_files"},
        )
        return 0  # Fallback value with audit trail
```

**ì›ì¹™**:
- **ëª¨ë“  ìŠ¤í‚µì€ ë¡œê¹…**: ì‚¬ìš©ìê°€ ì¶”ì  ê°€ëŠ¥
- **Fallback ê°’ ëª…ì‹œ**: 0/False/Noneì˜ ì˜ë¯¸ ëª…í™•í™”
- **ì»¨í…ìŠ¤íŠ¸ ë³´ì¡´**: ì™œ ìŠ¤í‚µëëŠ”ì§€ ê¸°ë¡

---

## ğŸ“Š **ì „ì²´ í”„ë¡œì íŠ¸ ì§„ì²™ë„**

```
=================================================================
                  AniVault ë¦¬íŒ©í† ë§ ì§„í–‰ í˜„í™©
=================================================================

âœ… Stage 1: ë³´ì•ˆ ì¦‰ì‹œ ì¡°ì¹˜                     3/3   (100%)
âœ… Stage 2: CLI í•¸ë“¤ëŸ¬ Silent Failure         20/20  (100%)
âœ… Stage 3.1: íŒŒì´í”„ë¼ì¸ íˆ¬ëª…ì„±                 3/3   (100%)
âœ… Stage 3.2: ë¡œê·¸ í•¸ë“¤ëŸ¬                      2/2   (100%)
ğŸ“‹ Stage 3.3+: ë‚˜ë¨¸ì§€ HIGH ì‹¬ê°ë„             0/28   (0%)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ì „ì²´ ì§„í–‰ë¥ :                                  28/56  (50%) ğŸ‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ì˜ˆìƒ ì™„ë£Œì¼: 2025-11-18 (Week 2-ë§)
```

---

## ğŸš€ **Week 2 ëª©í‘œ vs ì‹¤ì œ**

### **ëª©í‘œ (Week 1-2)**
- HIGH ì‹¬ê°ë„ 30-35ê°œ ì™„ë£Œ (50-60%)

### **ì‹¤ì œ (Day 1)**
- **28ê°œ ì™„ë£Œ (50%)** â† **ëª©í‘œ ë‹¬ì„±!**
- **44ê°œ í…ŒìŠ¤íŠ¸ ì‘ì„±** â† **ë³´ë„ˆìŠ¤!**
- **4ê°œ íŒ¨í„´ í™•ë¦½** â† **ì¬ì‚¬ìš© ê°€ëŠ¥**

---

## ğŸ“‹ **ë‚¨ì€ ì‘ì—… (28ê°œ)**

### **ìš°ì„ ìˆœìœ„**
1. **sqlite_cache_db.py** (3ê°œ) - ë°ì´í„° ë¬´ê²°ì„±
2. **tmdb_client.py** (3ê°œ) - API í´ë¼ì´ì–¸íŠ¸
3. **verify_handler.py** (2ê°œ) - CLI í•¸ë“¤ëŸ¬
4. **ë‚˜ë¨¸ì§€** (20ê°œ) - ê¸°íƒ€ ëª¨ë“ˆ

### **ì˜ˆìƒ ì†Œìš”**
- **Today ë‚¨ì€ ì‹œê°„**: 5-8ê°œ (1-2ì‹œê°„)
- **Tomorrow**: 10-15ê°œ (3-4ì‹œê°„)
- **Day 3**: 5-5ê°œ (ë§ˆë¬´ë¦¬)

---

## âœ… **í’ˆì§ˆ ê²Œì´íŠ¸**

### **ì „ì²´ í…ŒìŠ¤íŠ¸ í˜„í™©**
```bash
Failure-First Tests:
  rollback_handler:      8/8  âœ…
  metadata_enricher:     9/9  âœ…
  organize_handler:      7/7  âœ…
  scanner:               4/4  âœ…
  log_handler:           4/4  âœ…

Total:                  32/32 âœ… (100%)

íšŒê·€ í…ŒìŠ¤íŠ¸:
  organize tests:       14/14 âœ…
  (ê¸°íƒ€ íšŒê·€ í…ŒìŠ¤íŠ¸ ëŒ€ê¸°)
```

---

## ğŸ¯ **ë‹¤ìŒ ì„¸ì…˜ ì•¡ì…˜**

```bash
# 1. í˜„ì¬ ìƒíƒœ í™•ì¸
git status --short
pytest tests/  # ì „ì²´ íšŒê·€ í…ŒìŠ¤íŠ¸

# 2. ë‹¤ìŒ ëŒ€ìƒ: sqlite_cache_db.py (3ê°œ)
grep -n "sqlite_cache_db" error_violations.json

# 3. Failure-First í…ŒìŠ¤íŠ¸ ì‘ì„±
# tests/services/test_sqlite_cache_db_failures.py

# 4. ë¦¬íŒ©í† ë§ ì§„í–‰
# src/anivault/services/sqlite_cache_db.py
```

---

**ë¦¬ë·°ì–´**: ìœ¤ë„í˜„, ê¹€ì§€ìœ , ìµœë¡œê±´
**ìŠ¹ì¸ ìƒíƒœ**: âœ… Stage 3.1-3.2 ì™„ë£Œ (50% ë§ˆì¼ìŠ¤í†¤ ë‹¬ì„±!)
**ë‹¤ìŒ ë‹¨ê³„**: Stage 3.3 (sqlite_cache_db.py)
