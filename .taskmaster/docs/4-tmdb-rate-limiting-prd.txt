# AniVault v3 CLI - TMDB Rate Limiting PRD

## Overview
Implement TMDB API integration with comprehensive rate limiting state machine, token bucket algorithm, and Retry-After header handling. This includes state transitions, error classification, and multi-process safety considerations.

## Goals
- Implement token bucket algorithm (default 35 rps, TMDB ceiling ~50 rps safety margin)
- Create rate limiting state machine with proper transitions
- Handle Retry-After headers with seconds and HTTP-date format support
- Implement error classification and backoff strategies
- Ensure multi-process safety and stability

## Success Criteria
- 429 scenario automatic recovery demonstrated
- State machine transitions working correctly
- Retry-After header parsing (seconds/HTTP-date)
- Exponential backoff logic verified
- Multi-process environment stability confirmed

## Technical Requirements

### Token Bucket Implementation
- **Default rate**: 35 rps (TMDB ceiling ~50 rps safety margin)
- **Semaphore concurrency control**: Default 4 concurrent requests
- **Multi-process safety**: Thread-safe token bucket implementation
- **Configurable parameters**: CLI options for rate adjustment

### Rate Limiting State Machine
- **States**: Normal ↔ Throttle ↔ Sleep ↔ HalfOpen ↔ CacheOnly
- **Transitions**:
  - 429 → Throttle (with Retry-After priority)
  - Sliding window error ratio calculation
  - Circuit breaker with hysteresis (flapping prevention)
  - CacheOnly fallback for persistent failures

### Retry-After Handling
- **Seconds format**: Direct numeric value parsing
- **HTTP-date format**: RFC 7231 date format support
- **Clock skew correction**: Negative/past times → 1s minimum
- **Full Jitter backoff**: Randomized retry intervals

### Error Classification
- **Backoff targets**: 429, 5xx, ConnectTimeout, ReadTimeout, DNS/ConnectionError
- **Non-backoff targets**: 401/403/404/422 (client responsibility)
- **Error ratio calculation**: Sliding window approach
- **Circuit breaker**: 5min+ 429/5xx ratio >60% → CacheOnly

## Deliverables
- [ ] **Token bucket implementation:**
  - [ ] Default 35 rps (TMDB ceiling ~50 rps safety margin)
  - [ ] Semaphore concurrency control (default 4)
  - [ ] Multi-process safety considerations
- [ ] **Rate limiting state machine:**
  - [ ] States: Normal ↔ Throttle ↔ Sleep ↔ HalfOpen ↔ CacheOnly
  - [ ] 429→Throttle transition with Retry-After priority
  - [ ] Sliding window error ratio calculation
  - [ ] Circuit breaker with hysteresis (flapping prevention)
- [ ] **Retry-After handling:**
  - [ ] Seconds and HTTP-date format support
  - [ ] Clock skew correction (negative/past times → 1s minimum)
  - [ ] Full Jitter backoff strategy
- [ ] **Error classification:**
  - [ ] Backoff targets: 429, 5xx, ConnectTimeout, ReadTimeout, DNS/ConnectionError
  - [ ] Non-backoff targets: 401/403/404/422 (client responsibility)

## Definition of Done
- [ ] 429 scenario automatic recovery demonstrated
- [ ] State machine transitions working correctly
- [ ] Retry-After header parsing (seconds/HTTP-date)
- [ ] Exponential backoff logic verified
- [ ] Multi-process environment stability confirmed
- [ ] Circuit breaker functionality tested
- [ ] Error classification working correctly

## State Machine Details

### Normal State
- **Default operation**: Full API access
- **Token bucket**: 35 rps rate limiting
- **Concurrency**: 4 concurrent requests
- **Monitoring**: Error ratio calculation

### Throttle State
- **Trigger**: 429 response received
- **Action**: Retry-After header respect
- **Duration**: Retry-After value or exponential backoff
- **Transition**: Back to Normal or CacheOnly

### CacheOnly State
- **Trigger**: Persistent failures or circuit breaker
- **Action**: Use cached data only, no API calls
- **Duration**: 10 minutes or manual reset
- **Transition**: Back to Normal after recovery

### Circuit Breaker
- **Threshold**: 5min+ 429/5xx ratio >60%
- **Action**: Automatic CacheOnly transition
- **Recovery**: 10 minutes or manual reset
- **Hysteresis**: Prevent flapping between states

## Error Handling Strategy
1. **429 responses**: Immediate Throttle state, Retry-After respect
2. **5xx errors**: Exponential backoff, circuit breaker consideration
3. **Network timeouts**: Retry with backoff, timeout handling
4. **DNS/Connection errors**: Network issue detection, CacheOnly fallback
5. **Client errors (401/403/404/422)**: No backoff, immediate failure

## Testing Requirements
- **429 scenario testing**: Automatic recovery demonstration
- **State machine testing**: All transitions verified
- **Retry-After parsing**: Both formats tested
- **Multi-process testing**: Thread safety verification
- **Circuit breaker testing**: Threshold and recovery testing
- **Error classification testing**: All error types handled

## Risk Mitigation
- **TMDB policy changes**: Configurable rate limits
- **429 handling**: Retry-After header priority
- **Circuit breaker**: Prevent API abuse
- **Multi-process safety**: Thread-safe implementation
- **Network issues**: Graceful degradation to CacheOnly

## Timeline
**Weeks 9-10**: TMDB rate limiting implementation
**Priority**: HIGH - TMDB API integration with rate limiting

## Dependencies
- Requires completion of `1-foundation-setup`, `2-single-exe-poc`, and `3-scan-parse-pipeline` tags
- File processing pipeline established
- Memory optimization completed
