# AniVault 상세 아키텍처 분석

## 핵심 아키텍처 패턴

### 1. MVVM (Model-View-ViewModel) 패턴
- **View**: PyQt5 GUI 컴포넌트 (main_window.py, panels)
- **ViewModel**: 비즈니스 로직과 데이터 바인딩 (FileProcessingViewModel)
- **Model**: 데이터 모델과 비즈니스 엔티티 (AnimeFile, FileGroup, TMDBAnime)

### 2. 파이프라인 기반 처리 시스템
```
파일 스캔 → 그룹화 → 파싱 → 메타데이터 검색 → 파일 이동
```

### 3. 비동기 작업 처리
- **FilePipelineWorker**: 백그라운드 작업 처리
- **ThreadPoolExecutor**: 병렬 파일 처리
- **PyQt5 시그널/슬롯**: 이벤트 기반 통신

## 핵심 컴포넌트 분석

### FileProcessingViewModel (1,069줄)
- **역할**: 전체 파일 처리 파이프라인 오케스트레이션
- **주요 기능**:
  - 파일 스캔 및 발견
  - 파일 그룹화 및 유사성 분석
  - 애니메이션 정보 파싱
  - TMDB 메타데이터 검색
  - 파일 정리 및 이동
- **특징**:
  - 자동 체이닝 지원 (단계별 자동 진행)
  - 실시간 진행률 추적
  - 에러 처리 및 복구

### TMDBClient (1,853줄)
- **역할**: The Movie Database API 클라이언트
- **주요 기능**:
  - TV 시리즈 및 영화 검색
  - 메타데이터 상세 정보 조회
  - 다국어 지원 (한국어 우선)
  - 캐싱 및 재시도 로직
- **고급 기능**:
  - 포괄적 검색 전략 (Multi Search + Fallback)
  - 품질 점수 계산 시스템
  - Rate Limiting 처리
  - 지수 백오프 재시도

### FileScanner (317줄)
- **역할**: 디렉토리 스캔 및 파일 발견
- **지원 형식**:
  - 비디오: .mkv, .mp4, .avi, .mov, .wmv, .flv, .webm, .m4v, .3gp, .ogv, .ts, .m2ts, .mts
  - 자막: .srt, .ass, .ssa, .vtt, .sub, .idx, .smi, .sami
- **특징**:
  - 병렬 처리 (ThreadPoolExecutor)
  - 재귀적 디렉토리 탐색
  - 진행률 콜백 지원

### DatabaseManager (1,264줄)
- **역할**: SQLAlchemy 기반 데이터베이스 관리
- **주요 기능**:
  - 트랜잭션 관리 (TransactionManager)
  - CRUD 작업
  - 벌크 작업 (bulk insert/update)
  - 스키마 검증
- **고급 기능**:
  - 자동 롤백 트랜잭션
  - 벌크 업서트 (insert or update)
  - 스키마 버전 관리
  - 트랜잭션 통계

## 데이터 모델 구조

### 핵심 엔티티
1. **AnimeFile**: 파일 기본 정보
2. **FileGroup**: 유사한 파일들의 그룹
3. **TMDBAnime**: TMDB 메타데이터
4. **AnimeMetadata**: 데이터베이스 저장용 메타데이터
5. **ParsedFile**: 파싱된 파일 정보

### 관계 구조
```
AnimeMetadata (1) ←→ (N) ParsedFile
FileGroup (1) ←→ (N) AnimeFile
```

## 기술적 특징

### 1. 에러 처리 및 복구
- **Circuit Breaker 패턴**: API 호출 실패 시 자동 차단
- **재시도 로직**: 지수 백오프와 지터 적용
- **트랜잭션 롤백**: 데이터 일관성 보장

### 2. 성능 최적화
- **병렬 처리**: 파일 스캔 및 처리
- **캐싱**: TMDB API 응답 캐싱
- **벌크 작업**: 대량 데이터 처리
- **지연 로딩**: 필요시에만 데이터 로드

### 3. 확장성
- **플러그인 아키텍처**: 새로운 파일 형식 추가 용이
- **설정 기반**: 동적 설정 변경
- **모듈화**: 독립적인 컴포넌트들

### 4. 사용자 경험
- **실시간 피드백**: 진행률 및 상태 업데이트
- **자동화**: 파이프라인 자동 실행
- **에러 복구**: 실패한 작업 재시도

## 코드 품질 특징

### 1. 타입 안전성
- **Python 3.10+ 타입 힌트**: 모든 함수에 타입 어노테이션
- **Union 타입**: Optional 값 처리
- **제네릭**: 재사용 가능한 타입 정의

### 2. 문서화
- **Google 스타일 docstring**: 모든 클래스/함수 문서화
- **상세한 주석**: 복잡한 로직 설명
- **예제 코드**: 사용법 예시

### 3. 테스트 가능성
- **의존성 주입**: 테스트용 모킹 용이
- **인터페이스 분리**: 작은 단위 테스트 가능
- **에러 시나리오**: 예외 상황 테스트

## 개선 가능한 영역

### 1. 성능
- **메모리 사용량**: 대용량 파일 처리 시 최적화
- **데이터베이스 쿼리**: N+1 문제 해결
- **캐시 전략**: 더 효율적인 캐싱

### 2. 사용성
- **사용자 인터페이스**: 더 직관적인 GUI
- **설정 관리**: 사용자 친화적 설정
- **에러 메시지**: 더 명확한 오류 안내

### 3. 확장성
- **플러그인 시스템**: 더 유연한 확장
- **API 설계**: RESTful API 추가
- **마이크로서비스**: 서비스 분리 고려
